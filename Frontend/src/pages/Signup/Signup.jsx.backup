import React, { useEffect, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import { useQueryClient } from "@tanstack/react-query";
import { toast } from "react-hot-toast";
import { register, sendOtp, verifyOtp } from "../../lib/api";
import Loader from "../../components/Loading/Loading";
import "./Signup.css";
import img from "../../assets/image.png";

const Signup = () => {
  const [mincount, setminCount] = useState(5);
  const [seccount, setsecCount] = useState(0);
  const [timerActive, setTimerActive] = useState(false);
  const [resenttimer, setresenttimer] = useState(0);
  const [resendDisabled, setResendDisabled] = useState(false);

  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [step, setStep] = useState(1); // 1: form, 2: OTP verification
  const [formData, setFormData] = useState({
    name: "",
    email: "",
    password: "",
    confirmPassword: "",
  });

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prevState) => ({
      ...prevState,
      [name]: value.trim(),
    }));
    if (error) setError("");
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // Validate form
    if (
      !formData.name ||
      !formData.email ||
      !formData.password ||
      !formData.confirmPassword
    ) {
      toast.error("Please fill in all fields");
      return;
    }

    if (formData.password !== formData.confirmPassword) {
      toast.error("Passwords do not match");
      return;
    }

    if (formData.password.length < 6) {
      toast.error("Password must be at least 6 characters");
      return;
    }

    setIsLoading(true);
    setError("");

    try {
      console.log("üîÑ Registering user...");
      const response = await register(formData);
      console.log("‚úÖ Registration successful:", response);

      queryClient.invalidateQueries();
      toast.success("Registration successful! Welcome to ExTrackify!");
      navigate("/dashboard");
    } catch (error) {
      console.error("‚ùå Registration error:", error);
      const errorMessage =
        error.response?.data?.message || error.message || "Registration failed";
      
      if (errorMessage.includes("already exists")) {
        toast.error("User already exists. Please login instead.");
      } else {
        toast.error(errorMessage);
      }
      setError(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    return (
      <div className="signup-page">
        {isLoading && <Loader />}
        
        <div className="signup-container">
          <div className="signup-left">
            <div className="signup-brand" onClick={() => navigate("/")}>
              <img src={img} alt="ExTrackify Logo" className="brand-logo" />
              <h1 className="brand-name">EXTRAKIFY</h1>
            </div>
            
            <div className="signup-illustration">
              <div className="floating-card">
                <div className="card-icon">üöÄ</div>
                <p>Get Started Fast</p>
              </div>
              <div className="floating-card">
                <div className="card-icon">üîê</div>
                <p>Secure & Private</p>
              </div>
              <div className="floating-card">
                <div className="card-icon">üì±</div>
                <p>Access Anywhere</p>
              </div>
            </div>
            
            <div className="signup-tagline">
              <h2>Join ExTrackify Today</h2>
              <p>Create your account and start managing your finances like a pro</p>
            </div>
          </div>

          <div className="signup-right">
            <div className="signup-form-wrapper">
              <div className="signup-header">
                <h1>Create Account</h1>
                <p>Fill in your details to get started</p>
              </div>

              {error && (
                <div className="error-alert" role="alert">
                  <span className="error-icon">‚ö†Ô∏è</span>
                  <span>{error}</span>
                </div>
              )}

              <form onSubmit={handleSendOtp} noValidate className="signup-form">
                <div className="input-group">
                  <label htmlFor="name">Full Name</label>
                  <div className="input-wrapper">
                    <span className="input-icon">üë§</span>
                    <input
                      id="name"
                      type="text"
                      name="name"
                      placeholder="John Doe"
                      value={formData.name}
                      onChange={handleChange}
                      required
                      disabled={isLoading}
    <div className="signup-page">
      {isLoading && <Loader />}
      
      <div className="signup-container">
        <div className="signup-left">
          <div className="signup-brand" onClick={() => navigate("/")}>
            <img src={img} alt="ExTrackify Logo" className="brand-logo" />
            <h1 className="brand-name">EXTRAKIFY</h1>
          </div>
          
          <div className="signup-illustration">
            <div className="floating-card">
              <div className="card-icon">üöÄ</div>
              <p>Get Started Fast</p>
            </div>
            <div className="floating-card">
              <div className="card-icon">üîê</div>
              <p>Secure & Private</p>
            </div>
            <div className="floating-card">
              <div className="card-icon">üì±</div>
              <p>Access Anywhere</p>
            </div>
          </div>
          
          <div className="signup-tagline">
            <h2>Join ExTrackify Today</h2>
            <p>Create your account and start managing your finances like a pro</p>
          </div>
        </div>

        <div className="signup-right">
          <div className="signup-form-wrapper">
            <div className="signup-header">
              <h1>Create Account</h1>
              <p>Fill in your details to get started</p>
            </div>

            {error && (
              <div className="error-alert" role="alert">
                <span className="error-icon">‚ö†Ô∏è</span>
                <span>{error}</span>
              </div>
            )}

            <form onSubmit={handleSubmit} noValidate className="signup-form">
                      value={formData.confirmPassword}
                      onChange={handleChange}
                      required
                      disabled={isLoading}
                      minLength={6}
                    />
                  </div>
                </div>

                <button type="submit" className="signup-btn" disabled={isLoading}>
                  {isLoading ? (
              <button type="submit" className="signup-btn" disabled={isLoading}>
                {isLoading ? (
                  <span className="btn-loading">
                    <span className="spinner"></span>
                    Creating Account...
                  </span>
                ) : (
                  <span>Sign Up</span>
                )}
              </button>
            </form>

            <div className="login-prompt">
              <p>Already have an account? <Link to="/login" className="login-link">Login</Link></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
export default Signup;
